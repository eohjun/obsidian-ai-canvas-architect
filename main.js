/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var J=Object.defineProperty;var re=Object.getOwnPropertyDescriptor;var ie=Object.getOwnPropertyNames;var oe=Object.prototype.hasOwnProperty;var ae=(c,e)=>{for(var t in e)J(c,t,{get:e[t],enumerable:!0})},de=(c,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of ie(e))!oe.call(c,n)&&n!==t&&J(c,n,{get:()=>e[n],enumerable:!(s=re(e,n))||s.enumerable});return c};var le=c=>de(J({},"__esModule",{value:!0}),c);var Se={};ae(Se,{default:()=>W});module.exports=le(Se);var N=require("obsidian");var M={claude:{id:"claude",name:"Claude",displayName:"Anthropic Claude",endpoint:"https://api.anthropic.com/v1",defaultModel:"claude-sonnet-4-5-20250929",apiKeyPrefix:"sk-ant-"},openai:{id:"openai",name:"OpenAI",displayName:"OpenAI GPT",endpoint:"https://api.openai.com/v1",defaultModel:"gpt-4o-mini",apiKeyPrefix:"sk-"},gemini:{id:"gemini",name:"Gemini",displayName:"Google Gemini",endpoint:"https://generativelanguage.googleapis.com/v1beta",defaultModel:"gemini-3-flash-preview",apiKeyPrefix:"AIza"},grok:{id:"grok",name:"Grok",displayName:"xAI Grok",endpoint:"https://api.x.ai/v1",defaultModel:"grok-4-1-fast-non-reasoning"}},ee={"claude-sonnet-4-5-20250929":{id:"claude-sonnet-4-5-20250929",displayName:"Claude Sonnet 4.5",provider:"claude",maxTokens:16384,inputCostPer1M:3,outputCostPer1M:15},"claude-opus-4-5-20251101":{id:"claude-opus-4-5-20251101",displayName:"Claude Opus 4.5",provider:"claude",maxTokens:32768,inputCostPer1M:15,outputCostPer1M:75},"claude-3-5-haiku-20241022":{id:"claude-3-5-haiku-20241022",displayName:"Claude 3.5 Haiku",provider:"claude",maxTokens:8192,inputCostPer1M:.8,outputCostPer1M:4},"gpt-5.2":{id:"gpt-5.2",displayName:"GPT-5.2",provider:"openai",maxTokens:32768,inputCostPer1M:1.75,outputCostPer1M:14,isReasoning:!0},"o3-mini":{id:"o3-mini",displayName:"O3 Mini",provider:"openai",maxTokens:65536,inputCostPer1M:1.1,outputCostPer1M:4.4,isReasoning:!0},"gpt-4o":{id:"gpt-4o",displayName:"GPT-4o",provider:"openai",maxTokens:16384,inputCostPer1M:2.5,outputCostPer1M:10,isReasoning:!1},"gpt-4o-mini":{id:"gpt-4o-mini",displayName:"GPT-4o Mini",provider:"openai",maxTokens:16384,inputCostPer1M:.15,outputCostPer1M:.6,isReasoning:!1},"gemini-3-pro-preview":{id:"gemini-3-pro-preview",displayName:"Gemini 3 Pro",provider:"gemini",maxTokens:65536,inputCostPer1M:2.5,outputCostPer1M:10},"gemini-3-flash-preview":{id:"gemini-3-flash-preview",displayName:"Gemini 3 Flash",provider:"gemini",maxTokens:65536,inputCostPer1M:.5,outputCostPer1M:3},"gemini-2.0-flash":{id:"gemini-2.0-flash",displayName:"Gemini 2.0 Flash",provider:"gemini",maxTokens:8192,inputCostPer1M:.075,outputCostPer1M:.3},"grok-4-1-fast":{id:"grok-4-1-fast",displayName:"Grok 4.1 Fast",provider:"grok",maxTokens:16384,inputCostPer1M:3,outputCostPer1M:15},"grok-4-1-fast-non-reasoning":{id:"grok-4-1-fast-non-reasoning",displayName:"Grok 4.1 Fast (Non-Reasoning)",provider:"grok",maxTokens:16384,inputCostPer1M:.6,outputCostPer1M:4}};function Y(c){let e=ee[c];return(e==null?void 0:e.isReasoning)!==void 0?e.isReasoning:c.startsWith("gpt-5")||c.startsWith("o1")||c.startsWith("o3")}function te(c){return Object.values(ee).filter(e=>e.provider===c)}var se={ai:{provider:"openai",apiKeys:{claude:"",openai:"",gemini:"",grok:""},model:M.openai.defaultModel},canvas:{maxNodes:50,edgeThreshold:.7,nodeWidth:250,nodeHeight:150,outputFolder:""},clustering:{eps:200,minPts:2},embeddings:{folder:"09_Embedded"}};var f=require("obsidian");var R=class extends f.PluginSettingTab{constructor(t,s){super(t,s);this.plugin=s}display(){let{containerEl:t}=this;t.empty(),t.createEl("h1",{text:"AI Canvas Architect"}),t.createEl("p",{text:"Generate visual knowledge maps from your notes using AI-powered spatial reasoning.",cls:"setting-item-description"}),this.renderAISettings(t),this.renderCanvasSettings(t),this.renderClusteringSettings(t),this.renderEmbeddingsSettings(t)}renderAISettings(t){t.createEl("h2",{text:"AI Provider"});let s=this.plugin.settings.ai.provider,n=M[s];new f.Setting(t).setName("Provider").setDesc("Select the AI provider for generating cluster labels.").addDropdown(a=>{Object.entries(M).forEach(([l,g])=>{a.addOption(l,g.displayName)}),a.setValue(s).onChange(async l=>{let g=l;this.plugin.settings.ai.provider=g,this.plugin.settings.ai.model=M[g].defaultModel,await this.plugin.saveSettings(),this.display()})});let i=new f.Setting(t).setName(`${n.displayName} API Key`).setDesc(`Enter your ${n.displayName} API key for AI features.`).addText(a=>{a.setPlaceholder(n.apiKeyPrefix?`${n.apiKeyPrefix}...`:"Enter API key...").setValue(this.plugin.settings.ai.apiKeys[s]).onChange(async l=>{this.plugin.settings.ai.apiKeys[s]=l,await this.plugin.saveSettings()}),a.inputEl.type="password",a.inputEl.style.width="250px"}).addButton(a=>{a.setButtonText("Test").onClick(async()=>{let l=this.plugin.settings.ai.apiKeys[s];if(!l){new f.Notice(`Please enter your ${n.displayName} API key first.`);return}a.setDisabled(!0),a.setButtonText("Testing...");try{await this.plugin.testApiKey(s,l)?new f.Notice(`\u2705 ${n.displayName} API key is valid!`):new f.Notice(`\u274C ${n.displayName} API key is invalid.`)}catch(g){new f.Notice(`\u274C Failed to test API key: ${g.message}`)}finally{a.setDisabled(!1),a.setButtonText("Test")}})}).descEl.createEl("a",{text:`Get ${n.name} API Key`,href:this.getApiKeyUrl(s)});i.style.display="block",i.style.marginTop="4px";let o=te(s),d=this.plugin.settings.ai.model;new f.Setting(t).setName("Model").setDesc("Select the AI model for generating labels.").addDropdown(a=>{o.forEach(l=>{a.addOption(l.id,l.displayName)}),o.find(l=>l.id===d)||a.addOption(d,d),a.setValue(d).onChange(async l=>{this.plugin.settings.ai.model=l,await this.plugin.saveSettings()})})}getApiKeyUrl(t){return{claude:"https://console.anthropic.com/settings/keys",openai:"https://platform.openai.com/api-keys",gemini:"https://aistudio.google.com/app/apikey",grok:"https://console.x.ai/"}[t]}renderCanvasSettings(t){t.createEl("h2",{text:"Canvas"}),new f.Setting(t).setName("Maximum nodes").setDesc("Maximum number of notes to include in generated canvas (10-100).").addSlider(s=>{s.setLimits(10,100,5).setValue(this.plugin.settings.canvas.maxNodes).setDynamicTooltip().onChange(async n=>{this.plugin.settings.canvas.maxNodes=n,await this.plugin.saveSettings()})}),new f.Setting(t).setName("Edge threshold").setDesc("Minimum similarity (0.5-1.0) to create connections between notes.").addSlider(s=>{s.setLimits(.5,1,.05).setValue(this.plugin.settings.canvas.edgeThreshold).setDynamicTooltip().onChange(async n=>{this.plugin.settings.canvas.edgeThreshold=n,await this.plugin.saveSettings()})}),new f.Setting(t).setName("Node width").setDesc("Width of note cards in pixels.").addText(s=>{s.setValue(String(this.plugin.settings.canvas.nodeWidth)).onChange(async n=>{let r=parseInt(n);!isNaN(r)&&r>50&&r<1e3&&(this.plugin.settings.canvas.nodeWidth=r,await this.plugin.saveSettings())})}),new f.Setting(t).setName("Node height").setDesc("Height of note cards in pixels.").addText(s=>{s.setValue(String(this.plugin.settings.canvas.nodeHeight)).onChange(async n=>{let r=parseInt(n);!isNaN(r)&&r>50&&r<1e3&&(this.plugin.settings.canvas.nodeHeight=r,await this.plugin.saveSettings())})}),new f.Setting(t).setName("Default output folder").setDesc("Default folder for saving generated canvases. Leave empty for vault root.").addText(s=>{s.setPlaceholder("e.g., Canvas").setValue(this.plugin.settings.canvas.outputFolder).onChange(async n=>{this.plugin.settings.canvas.outputFolder=n,await this.plugin.saveSettings()})})}renderClusteringSettings(t){t.createEl("h2",{text:"Clustering"}),new f.Setting(t).setName("Cluster radius (eps)").setDesc("Maximum distance (pixels) between notes to be considered neighbors.").addSlider(s=>{s.setLimits(100,500,25).setValue(this.plugin.settings.clustering.eps).setDynamicTooltip().onChange(async n=>{this.plugin.settings.clustering.eps=n,await this.plugin.saveSettings()})}),new f.Setting(t).setName("Minimum cluster size").setDesc("Minimum number of notes to form a cluster group.").addSlider(s=>{s.setLimits(2,10,1).setValue(this.plugin.settings.clustering.minPts).setDynamicTooltip().onChange(async n=>{this.plugin.settings.clustering.minPts=n,await this.plugin.saveSettings()})})}renderEmbeddingsSettings(t){t.createEl("h2",{text:"Embeddings"}),new f.Setting(t).setName("Embeddings folder").setDesc("Path to the Vault Embeddings plugin folder.").addText(n=>{n.setPlaceholder("09_Embedded").setValue(this.plugin.settings.embeddings.folder).onChange(async r=>{this.plugin.settings.embeddings.folder=r,await this.plugin.saveSettings()})});let s=t.createDiv({cls:"aca-embeddings-status"});this.checkEmbeddingsStatus(s)}async checkEmbeddingsStatus(t){let s=this.plugin.settings.embeddings.folder,n=(0,f.normalizePath)(`${s}/index.json`);if(await this.app.vault.adapter.exists(n))try{let i=await this.app.vault.adapter.read(n),o=JSON.parse(i),d=Object.keys(o.notes||{}).length;t.createEl("div",{text:`\u2713 Connected: ${d} note embeddings available`,cls:"aca-status-success"})}catch(i){t.createEl("div",{text:"\u26A0 Error reading embeddings index",cls:"aca-status-warning"})}else t.createEl("div",{text:"\u2717 Vault Embeddings not found. Please install and configure the plugin.",cls:"aca-status-error"})}};var C=require("obsidian"),G=class extends C.Modal{constructor(e,t,s,n,r){super(e),this.onSubmit=s,this.options={topic:n||"",seedNotePath:r,maxNodes:t.canvas.maxNodes,minSimilarity:t.canvas.edgeThreshold,includeClusterLabels:!0,showEdges:!0,outputFolder:t.canvas.outputFolder||""}}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("aca-modal"),e.createEl("h2",{text:"Generate Knowledge Canvas"}),this.options.seedNotePath?e.createEl("p",{text:`Creating canvas based on: ${this.options.seedNotePath}`,cls:"aca-modal-seed-info"}):new C.Setting(e).setName("Topic").setDesc("Enter a topic to explore. Related notes will be found automatically.").addText(r=>{r.setPlaceholder("e.g., Systems Thinking").setValue(this.options.topic||"").onChange(i=>{this.options.topic=i}),r.inputEl.focus()}),new C.Setting(e).setName("Maximum notes").setDesc("Number of related notes to include.").addSlider(r=>{r.setLimits(5,50,5).setValue(this.options.maxNodes).setDynamicTooltip().onChange(i=>{this.options.maxNodes=i})}),new C.Setting(e).setName("Similarity threshold").setDesc("Minimum similarity for creating connections (0.5-1.0).").addSlider(r=>{r.setLimits(.5,1,.05).setValue(this.options.minSimilarity).setDynamicTooltip().onChange(i=>{this.options.minSimilarity=i})}),new C.Setting(e).setName("Generate cluster labels").setDesc("Use AI to generate labels for note clusters.").addToggle(r=>{r.setValue(this.options.includeClusterLabels).onChange(i=>{this.options.includeClusterLabels=i})}),new C.Setting(e).setName("Show connections").setDesc("Draw lines between similar notes.").addToggle(r=>{r.setValue(this.options.showEdges).onChange(i=>{this.options.showEdges=i})}),new C.Setting(e).setName("Output folder").setDesc("Where to save the generated canvas (leave empty for vault root).").addText(r=>{r.setPlaceholder("e.g., Canvas").setValue(this.options.outputFolder).onChange(i=>{this.options.outputFolder=i})});let t=e.createDiv({cls:"aca-modal-buttons"});t.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),t.createEl("button",{text:"Generate Canvas",cls:"mod-cta"}).addEventListener("click",()=>{if(!this.options.topic&&!this.options.seedNotePath){new C.Notice("Please enter a topic or select a seed note.");return}this.onSubmit(this.options),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}};var ne=require("obsidian"),F=class extends ne.Modal{constructor(t,s){super(t);this.steps=[];this.isCancelled=!1;this.onCancel=s}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("aca-progress-modal"),t.createEl("h2",{text:"Generating Canvas..."}),this.stepsContainer=t.createDiv({cls:"aca-progress-steps"}),this.statusMessage=t.createDiv({cls:"aca-progress-status"}),this.onCancel&&t.createEl("button",{text:"Cancel",cls:"aca-progress-cancel"}).addEventListener("click",()=>{var n;this.isCancelled=!0,(n=this.onCancel)==null||n.call(this),this.close()})}onClose(){let{contentEl:t}=this;t.empty()}initSteps(t){this.steps=t.map(s=>({label:s,status:"pending"})),this.renderSteps()}updateStep(t,s,n){t>=0&&t<this.steps.length&&(this.steps[t].status=s,this.steps[t].message=n,this.renderSteps())}setCurrentStep(t){this.steps.forEach((s,n)=>{n<t?s.status="completed":n===t?s.status="running":s.status="pending"}),this.renderSteps()}complete(t){this.steps.forEach(s=>{s.status!=="error"&&(s.status="completed")}),this.renderSteps(),t&&this.setStatus(t)}setError(t,s){t>=0&&t<this.steps.length&&(this.steps[t].status="error",this.steps[t].message=s,this.renderSteps()),this.setStatus(`Error: ${s}`)}setStatus(t){this.statusMessage.textContent=t}get cancelled(){return this.isCancelled}renderSteps(){this.stepsContainer.empty();for(let t of this.steps){let s=this.stepsContainer.createDiv({cls:`aca-progress-step aca-step-${t.status}`}),n=s.createSpan({cls:"aca-step-icon"});switch(t.status){case"pending":n.textContent="\u25CB";break;case"running":n.textContent="\u25D0",n.addClass("aca-step-spinning");break;case"completed":n.textContent="\u2713";break;case"error":n.textContent="\u2717";break}s.createSpan({text:t.label,cls:"aca-step-label"}),t.message&&s.createSpan({text:` - ${t.message}`,cls:"aca-step-message"})}}};var b=class c{constructor(e,t){this.x=e;this.y=t}static origin(){return new c(0,0)}static from(e){return new c(e.x,e.y)}distanceTo(e){let t=this.x-e.x,s=this.y-e.y;return Math.sqrt(t*t+s*s)}add(e){return new c(this.x+e.x,this.y+e.y)}subtract(e){return new c(this.x-e.x,this.y-e.y)}scale(e){return new c(this.x*e,this.y*e)}midpoint(e){return new c((this.x+e.x)/2,(this.y+e.y)/2)}equals(e){return this.x===e.x&&this.y===e.y}offset(e,t){return new c(this.x+e,this.y+t)}toObject(){return{x:this.x,y:this.y}}toString(){return`(${this.x}, ${this.y})`}};var y=class c{constructor(e,t){this.width=e;this.height=t;if(e<0||t<0)throw new Error("Dimension values must be non-negative")}static defaultNode(){return new c(250,150)}static square(e){return new c(e,e)}static from(e){return new c(e.width,e.height)}get area(){return this.width*this.height}get aspectRatio(){return this.height===0?0:this.width/this.height}scale(e){return new c(this.width*e,this.height*e)}pad(e){return new c(this.width+e*2,this.height+e*2)}contains(e){return this.width>=e.width&&this.height>=e.height}equals(e){return this.width===e.width&&this.height===e.height}toObject(){return{width:this.width,height:this.height}}toString(){return`${this.width}x${this.height}`}};var ce=0;function X(c="node"){return`${c}-${Date.now()}-${++ce}`}var $=class{constructor(e,t,s,n){this.id=e;this.position=t;this.dimension=s;this.color=n}get center(){return new b(this.position.x+this.dimension.width/2,this.position.y+this.dimension.height/2)}get bounds(){return{topLeft:this.position,bottomRight:new b(this.position.x+this.dimension.width,this.position.y+this.dimension.height)}}containsPoint(e){let{topLeft:t,bottomRight:s}=this.bounds;return e.x>=t.x&&e.x<=s.x&&e.y>=t.y&&e.y<=s.y}overlaps(e){let t=this.bounds,s=e.bounds;return!(t.bottomRight.x<s.topLeft.x||s.bottomRight.x<t.topLeft.x||t.bottomRight.y<s.topLeft.y||s.bottomRight.y<t.topLeft.y)}distanceTo(e){return this.center.distanceTo(e.center)}moveTo(e){this.position=e}moveBy(e,t){this.position=this.position.offset(e,t)}},E=class c extends ${constructor(t,s,n,r,i){super(t,s,n,i);this.filePath=r;this.type="file"}static create(t,s,n,r){return new c(X("file"),s,n!=null?n:y.defaultNode(),t,r)}toCanvasFormat(){let t={id:this.id,type:this.type,x:this.position.x,y:this.position.y,width:this.dimension.width,height:this.dimension.height,file:this.filePath};return this.color&&(t.color=this.color.toString()),t}},B=class c extends ${constructor(t,s,n,r,i){super(t,s,n,i);this.text=r;this.type="text"}static create(t,s,n,r){return new c(X("text"),s,n!=null?n:y.defaultNode(),t,r)}toCanvasFormat(){let t={id:this.id,type:this.type,x:this.position.x,y:this.position.y,width:this.dimension.width,height:this.dimension.height,text:this.text};return this.color&&(t.color=this.color.toString()),t}},S=class c extends ${constructor(t,s,n,r,i){super(t,s,n,i);this.label=r;this.type="group"}static create(t,s,n,r){return new c(X("group"),t,s,n,r)}static fromNodes(t,s=50,n,r){if(t.length===0)return c.create(b.origin(),new y(200,150),n,r);let i=1/0,o=1/0,d=-1/0,a=-1/0;for(let l of t){let{topLeft:g,bottomRight:p}=l.bounds;i=Math.min(i,g.x),o=Math.min(o,g.y),d=Math.max(d,p.x),a=Math.max(a,p.y)}return c.create(new b(i-s,o-s),new y(d-i+s*2,a-o+s*2),n,r)}containsNode(t){let{topLeft:s,bottomRight:n}=this.bounds,r=t.bounds.topLeft,i=t.bounds.bottomRight;return r.x>=s.x&&r.y>=s.y&&i.x<=n.x&&i.y<=n.y}toCanvasFormat(){let t={id:this.id,type:this.type,x:this.position.x,y:this.position.y,width:this.dimension.width,height:this.dimension.height};return this.label&&(t.label=this.label),this.color&&(t.color=this.color.toString()),t}};var ue=0;function Q(){return`edge-${Date.now()}-${++ue}`}var A=class c{constructor(e,t,s,n,r,i,o,d,a){this.id=e;this.fromNode=t;this.toNode=s;this.fromSide=n;this.toSide=r;this.fromEnd=i;this.toEnd=o;this.color=d;this.label=a}static create(e,t,s){var n;return new c(Q(),e,t,s==null?void 0:s.fromSide,s==null?void 0:s.toSide,s==null?void 0:s.fromEnd,(n=s==null?void 0:s.toEnd)!=null?n:"arrow",s==null?void 0:s.color,s==null?void 0:s.label)}static createBidirectional(e,t,s){return new c(Q(),e,t,s==null?void 0:s.fromSide,s==null?void 0:s.toSide,"arrow","arrow",s==null?void 0:s.color,s==null?void 0:s.label)}static createConnection(e,t,s){return new c(Q(),e,t,s==null?void 0:s.fromSide,s==null?void 0:s.toSide,"none","none",s==null?void 0:s.color,s==null?void 0:s.label)}connects(e,t){return this.fromNode===e&&this.toNode===t||this.fromNode===t&&this.toNode===e}involves(e){return this.fromNode===e||this.toNode===e}getOtherNode(e){return this.fromNode===e?this.toNode:this.toNode===e?this.fromNode:null}toCanvasFormat(){let e={id:this.id,fromNode:this.fromNode,toNode:this.toNode};return this.fromSide&&(e.fromSide=this.fromSide),this.toSide&&(e.toSide=this.toSide),this.fromEnd&&(e.fromEnd=this.fromEnd),this.toEnd&&(e.toEnd=this.toEnd),this.color&&(e.color=this.color),this.label&&(e.label=this.label),e}};var T=class c{constructor(){this.nodes=new Map;this.edges=new Map}addNode(e){this.nodes.set(e.id,e)}addNodes(e){for(let t of e)this.addNode(t)}removeNode(e){if(!this.nodes.has(e))return!1;for(let[t,s]of this.edges)s.involves(e)&&this.edges.delete(t);return this.nodes.delete(e)}getNode(e){return this.nodes.get(e)}getAllNodes(){return Array.from(this.nodes.values())}getNodesByType(e){return Array.from(this.nodes.values()).filter(t=>t.type===e)}getFileNodes(){return this.getNodesByType("file")}getTextNodes(){return this.getNodesByType("text")}getGroupNodes(){return this.getNodesByType("group")}addEdge(e){if(!this.nodes.has(e.fromNode)||!this.nodes.has(e.toNode))throw new Error(`Cannot add edge: nodes ${e.fromNode} or ${e.toNode} not found`);this.edges.set(e.id,e)}addEdges(e){for(let t of e)this.addEdge(t)}removeEdge(e){return this.edges.delete(e)}getEdge(e){return this.edges.get(e)}getAllEdges(){return Array.from(this.edges.values())}getEdgesForNode(e){return Array.from(this.edges.values()).filter(t=>t.involves(e))}get nodeCount(){return this.nodes.size}get edgeCount(){return this.edges.size}getBounds(){let e=this.getAllNodes();if(e.length===0)return null;let t=1/0,s=1/0,n=-1/0,r=-1/0;for(let i of e){let{topLeft:o,bottomRight:d}=i.bounds;t=Math.min(t,o.x),s=Math.min(s,o.y),n=Math.max(n,d.x),r=Math.max(r,d.y)}return{min:new b(t,s),max:new b(n,r),dimension:new y(n-t,r-s)}}getCenter(){let e=this.getBounds();return e?e.min.midpoint(e.max):b.origin()}hasEdgeBetween(e,t){for(let s of this.edges.values())if(s.connects(e,t))return!0;return!1}getNeighbors(e){let t=[];for(let s of this.edges.values()){let n=s.getOtherNode(e);if(n){let r=this.nodes.get(n);r&&t.push(r)}}return t}toCanvasFormat(){let e=this.getGroupNodes(),t=this.getAllNodes().filter(s=>s.type!=="group");return{nodes:[...e,...t].map(s=>s.toCanvasFormat()),edges:this.getAllEdges().map(s=>s.toCanvasFormat())}}toJSON(){return JSON.stringify(this.toCanvasFormat(),null,2)}clear(){this.nodes.clear(),this.edges.clear()}static fromJSON(e){let t=new c;if(e.nodes&&Array.isArray(e.nodes))for(let s of e.nodes){let n=c.parseNode(s);n&&t.addNode(n)}if(e.edges&&Array.isArray(e.edges))for(let s of e.edges){let n=c.parseEdge(s);if(n)try{t.addEdge(n)}catch(r){}}return t}static parseNode(e){var t,s,n,r,i,o,d;try{let a=e.type,l=e.id,g=new b((t=e.x)!=null?t:0,(s=e.y)!=null?s:0),p=new y((n=e.width)!=null?n:250,(r=e.height)!=null?r:150);switch(a){case"file":return E.create((i=e.file)!=null?i:"",g,p);case"text":return B.create((o=e.text)!=null?o:"",g,p);case"group":return new S(l!=null?l:`group-${Date.now()}`,g,p,(d=e.label)!=null?d:"");default:return null}}catch(a){return null}}static parseEdge(e){try{let t=e.fromNode,s=e.toNode;return!t||!s?null:A.create(t,s,{label:e.label,fromSide:e.fromSide,toSide:e.toSide,fromEnd:e.fromEnd,toEnd:e.toEnd,color:e.color})}catch(t){return null}}};var ge={1:"Red",2:"Orange",3:"Yellow",4:"Green",5:"Cyan",6:"Purple"},pe={1:"#fb464c",2:"#e9973f",3:"#e0de71",4:"#44cf6e",5:"#53dfdd",6:"#a882ff"},j=class c{constructor(e){this.value=e}static preset(e){return new c(e)}static hex(e){if(!/^#[0-9A-Fa-f]{6}$/.test(e))throw new Error(`Invalid hex color: ${e}`);return new c(e)}static from(e){if(/^[1-6]$/.test(e))return c.preset(e);if(/^#[0-9A-Fa-f]{6}$/.test(e))return c.hex(e);throw new Error(`Invalid color: ${e}`)}static random(){let e=["1","2","3","4","5","6"],t=Math.floor(Math.random()*e.length);return c.preset(e[t])}static byIndex(e){let t=["1","2","3","4","5","6"];return c.preset(t[e%t.length])}get isPreset(){return/^[1-6]$/.test(this.value)}get hex(){return this.isPreset?pe[this.value]:this.value}get name(){return this.isPreset?ge[this.value]:this.value}toString(){return this.value}equals(e){return this.value===e.value}};var me={canvasWidth:2e3,canvasHeight:1500,padding:100,maxIterations:100,tolerance:1e-6},U=class{constructor(e){this.options={...me,...e}}cosineSimilarity(e,t){if(e.length!==t.length)throw new Error("Vectors must have the same length");let s=0,n=0,r=0;for(let i=0;i<e.length;i++)s+=e[i]*t[i],n+=e[i]*e[i],r+=t[i]*t[i];return n=Math.sqrt(n),r=Math.sqrt(r),n===0||r===0?0:s/(n*r)}computeDistanceMatrix(e){let t=e.length,s=Array(t).fill(null).map(()=>Array(t).fill(0));for(let n=0;n<t;n++)for(let r=n+1;r<t;r++){let i=this.cosineSimilarity(e[n],e[r]),o=Math.sqrt(2*(1-i));s[n][r]=o,s[r][n]=o}return s}doubleCentering(e){let t=e.length,s=Array(t).fill(null).map(()=>Array(t).fill(0)),n=e.map(d=>d.map(a=>a*a)),r=new Array(t).fill(0),i=new Array(t).fill(0),o=0;for(let d=0;d<t;d++)for(let a=0;a<t;a++)r[d]+=n[d][a],i[a]+=n[d][a],o+=n[d][a];for(let d=0;d<t;d++)r[d]/=t,i[d]/=t;o/=t*t;for(let d=0;d<t;d++)for(let a=0;a<t;a++)s[d][a]=-.5*(n[d][a]-r[d]-i[a]+o);return s}powerIteration(e,t){let s=e.length,n=t!=null?t:e,r=new Array(s).fill(0).map(()=>Math.random()-.5),i=Math.sqrt(r.reduce((d,a)=>d+a*a,0));r=r.map(d=>d/i);let o=0;for(let d=0;d<this.options.maxIterations;d++){let a=new Array(s).fill(0);for(let p=0;p<s;p++)for(let u=0;u<s;u++)a[p]+=n[p][u]*r[u];let l=a.reduce((p,u,m)=>p+u*r[m],0);if(i=Math.sqrt(a.reduce((p,u)=>p+u*u,0)),i===0)break;let g=a.map(p=>p/i);if(Math.abs(l-o)<this.options.tolerance)return{eigenvalue:l,eigenvector:g};o=l,r=g}return{eigenvalue:o,eigenvector:r}}deflateMatrix(e,t,s){let n=e.length,r=Array(n).fill(null).map(()=>Array(n).fill(0));for(let i=0;i<n;i++)for(let o=0;o<n;o++)r[i][o]=e[i][o]-t*s[i]*s[o];return r}extractCoordinates(e){let t=this.powerIteration(e),s=this.deflateMatrix(e,t.eigenvalue,t.eigenvector),n=this.powerIteration(e,s),r=Math.sqrt(Math.max(0,t.eigenvalue)),i=Math.sqrt(Math.max(0,n.eigenvalue)),o=t.eigenvector.map(a=>a*r),d=n.eigenvector.map(a=>a*i);return{x:o,y:d}}scaleToCanvas(e,t){let{canvasWidth:s,canvasHeight:n,padding:r}=this.options,i=Math.min(...e),o=Math.max(...e),d=Math.min(...t),a=Math.max(...t);o===i&&(i-=1,o+=1),a===d&&(d-=1,a+=1);let l=s-2*r,g=n-2*r;return e.map((p,u)=>{let m=r+(p-i)/(o-i)*l,v=r+(t[u]-d)/(a-d)*g;return new b(Math.round(m),Math.round(v))})}run(e){let{vectors:t,ids:s}=e;if(t.length!==s.length)throw new Error("Number of vectors must match number of IDs");if(t.length===0)return{coordinates:new Map};if(t.length===1){let l=this.options.canvasWidth/2,g=this.options.canvasHeight/2;return{coordinates:new Map([[s[0],new b(l,g)]])}}let n=this.computeDistanceMatrix(t),r=this.doubleCentering(n),{x:i,y:o}=this.extractCoordinates(r),d=this.scaleToCanvas(i,o),a=new Map;return s.forEach((l,g)=>{a.set(l,d[g])}),{coordinates:a}}};var he={eps:200,minPts:2},_=class{constructor(e){this.options={...he,...e}}distance(e,t){return e.distanceTo(t)}regionQuery(e,t){let s=[],n=e[t];for(let r=0;r<e.length;r++)this.distance(n.coordinate,e[r].coordinate)<=this.options.eps&&s.push(r);return s}expandCluster(e,t,s,n,r){t[s]=r;let i=[...n],o=new Set([s]);for(;i.length>0;){let d=i.shift();if(!o.has(d)&&(o.add(d),t[d]===-1&&(t[d]=r),t[d]===void 0)){t[d]=r;let a=this.regionQuery(e,d);if(a.length>=this.options.minPts)for(let l of a)o.has(l)||i.push(l)}}}calculateCentroid(e){if(e.length===0)return b.origin();let t=0,s=0;for(let n of e)t+=n.coordinate.x,s+=n.coordinate.y;return new b(Math.round(t/e.length),Math.round(s/e.length))}run(e){var d;if(e.length===0)return{clusters:[],noise:[],assignments:new Map};let t=new Array(e.length),s=0;for(let a=0;a<e.length;a++){if(t[a]!==void 0)continue;let l=this.regionQuery(e,a);l.length<this.options.minPts?t[a]=-1:(this.expandCluster(e,t,a,l,s),s++)}let n=new Map,r=new Map,i=[];for(let a=0;a<e.length;a++){let l=(d=t[a])!=null?d:-1;n.set(e[a].id,l),l===-1?i.push(e[a]):(r.has(l)||r.set(l,[]),r.get(l).push(e[a]))}let o=[];for(let[a,l]of r)o.push({clusterId:a,points:l,centroid:this.calculateCentroid(l)});return o.sort((a,l)=>a.clusterId-l.clusterId),{clusters:o,noise:i,assignments:n}}getStatistics(e){let t=e.clusters.map(s=>s.points.length);return{numClusters:e.clusters.length,numNoise:e.noise.length,avgClusterSize:t.length>0?t.reduce((s,n)=>s+n,0)/t.length:0,maxClusterSize:t.length>0?Math.max(...t):0,minClusterSize:t.length>0?Math.min(...t):0}}};var fe={canvasWidth:2e3,canvasHeight:1500,nodeWidth:250,nodeHeight:150,padding:100,clusterEps:200,clusterMinPts:2,edgeThreshold:.7,groupPadding:30},K=class{constructor(e){this.options={...fe,...e},this.mdsAlgorithm=new U({canvasWidth:this.options.canvasWidth,canvasHeight:this.options.canvasHeight,padding:this.options.padding}),this.dbscanAlgorithm=new _({eps:this.options.clusterEps,minPts:this.options.clusterMinPts})}computePositions(e){if(e.length===0)return new Map;let t=e.map(r=>r.vector),s=e.map(r=>r.noteId);return this.mdsAlgorithm.run({vectors:t,ids:s}).coordinates}createFileNodes(e,t){let s=new y(this.options.nodeWidth,this.options.nodeHeight);return e.map(n=>{var i;let r=(i=t.get(n.noteId))!=null?i:b.origin();return E.create(n.path,r,s)})}clusterNodes(e){let t=e.map(o=>({id:o.id,coordinate:o.position})),s=this.dbscanAlgorithm.run(t),n=new Map(e.map(o=>[o.id,o])),r=[];for(let o of s.clusters){let d=[];for(let a of o.points){let l=n.get(a.id);l&&d.push(l)}r.push({cluster:o,nodes:d})}let i=s.noise.map(o=>n.get(o.id)).filter(o=>o!==void 0);return{clusters:r,noise:i}}createGroupNodes(e){return e.map((t,s)=>{var i;let n=j.byIndex(s),r=(i=t.label)!=null?i:`Cluster ${s+1}`;return S.fromNodes(t.nodes,this.options.groupPadding,r,n)})}createEdges(e,t,s=this.options.edgeThreshold){let n=[],r=new Set;for(let i=0;i<e.length;i++)for(let o=i+1;o<e.length;o++){let d=this.cosineSimilarity(e[i].vector,e[o].vector);if(d>=s){let a=t.get(e[i].noteId),l=t.get(e[o].noteId);if(a&&l){let g=[a.id,l.id].sort().join("-");r.has(g)||(n.push(A.createConnection(a.id,l.id,{label:`${(d*100).toFixed(0)}%`})),r.add(g))}}}return n}cosineSimilarity(e,t){if(e.length!==t.length)return 0;let s=0,n=0,r=0;for(let i=0;i<e.length;i++)s+=e[i]*t[i],n+=e[i]*e[i],r+=t[i]*t[i];return n=Math.sqrt(n),r=Math.sqrt(r),n===0||r===0?0:s/(n*r)}resolveOverlaps(e,t=10){let s=Math.max(this.options.nodeWidth,this.options.nodeHeight)+20;for(let n=0;n<t;n++){let r=!1;for(let i=0;i<e.length;i++)for(let o=i+1;o<e.length;o++){let d=e[i],a=e[o];if(d.overlaps(a)){r=!0;let l=d.center,g=a.center,p=g.x-l.x,u=g.y-l.y;p===0&&u===0&&(p=(Math.random()-.5)*10,u=(Math.random()-.5)*10);let m=Math.sqrt(p*p+u*u),v=(s-m)/2+10,h=p/m*v,w=u/m*v;d.moveBy(-h,-w),a.moveBy(h,w)}}if(!r)break}}buildCanvas(e,t={}){var d;let s=new T;if(e.length===0)return s;let n=this.computePositions(e),r=this.createFileNodes(e,n),i=new Map;e.forEach((a,l)=>{i.set(a.noteId,r[l])}),this.resolveOverlaps(r);let{clusters:o}=this.clusterNodes(r);if(t.clusterLabels)for(let a of o){let l=t.clusterLabels.get(a.cluster.clusterId);l&&(a.label=l)}if(t.includeClusterLabels!==!1&&o.length>0){let a=this.createGroupNodes(o);s.addNodes(a)}if(s.addNodes(r),t.showEdges!==!1){let a=this.createEdges(e,i,(d=t.edgeThreshold)!=null?d:this.options.edgeThreshold);s.addEdges(a)}return s}};var V=class{constructor(e){this.deps=e}async execute(e){try{if(!this.deps.llmProvider.isConfigured())return{success:!1,labelsGenerated:0,error:"LLM provider not configured. Please add an API key in settings."};let{graph:t,pathToTitle:s,pathToSummary:n}=e,r=t.getGroupNodes(),i=t.getFileNodes();if(r.length===0)return{success:!0,labelsGenerated:0};let o=0;for(let d of r){let a=i.filter(u=>d.containsNode(u)),l=a.map(u=>s.get(u.filePath)).filter(u=>u!==void 0);if(l.length===0)continue;let g=n?a.map(u=>n.get(u.filePath)).filter(u=>u!==void 0):void 0,p=await this.deps.llmProvider.generateClusterLabel(l,g);p.success&&p.content&&(d.label=p.content.trim(),o++)}return{success:!0,labelsGenerated:o}}catch(t){return{success:!1,labelsGenerated:0,error:`Failed to label clusters: ${t.message}`}}}};var P=require("obsidian");var q=class{constructor(e){this.app=e}async save(e,t){let s=(0,P.normalizePath)(e),n=JSON.stringify(t.toCanvasFormat(),null,2);this.app.vault.getAbstractFileByPath(s)?await this.app.vault.adapter.write(s,n):await this.app.vault.create(s,n)}async load(e){let t=(0,P.normalizePath)(e);try{let s=await this.app.vault.adapter.read(t),n=JSON.parse(s);return T.fromJSON(n)}catch(s){return null}}async exists(e){let t=(0,P.normalizePath)(e);return await this.app.vault.adapter.exists(t)}async delete(e){let t=(0,P.normalizePath)(e),s=this.app.vault.getAbstractFileByPath(t);s&&await this.app.vault.delete(s)}async open(e){let t=(0,P.normalizePath)(e),s=this.app.vault.getAbstractFileByPath(t);s&&await this.app.workspace.getLeaf(!1).openFile(s)}async listCanvasFiles(){return this.app.vault.getFiles().filter(t=>t.extension==="canvas").map(t=>t.path)}generateCanvasPath(e,t=""){let s=new Date().toISOString().slice(0,10),r=`${e.replace(/[^a-zA-Z0-9가-힣\s-]/g,"").trim()}-${s}.canvas`;return t?(0,P.normalizePath)(`${t}/${r}`):r}};var H=require("obsidian"),be={embeddingsFolder:"09_Embedded",defaultSimilarityThreshold:.5};function ve(c){let e=0;for(let t=0;t<c.length;t++){let s=c.charCodeAt(t);e=(e<<5)-e+s,e=e&e}return Math.abs(e).toString(16).padStart(8,"0")}function z(c){let e=c.replace(/\.md$/,"");return ve(e)}var k=class{constructor(e,t){this.app=e;this.indexCache=null;this.embeddingsCache=new Map;this.allEmbeddingsCache=null;this.allEmbeddingsCacheTime=0;this.ALL_CACHE_TTL_MS=6e4;this.config={...be,...t}}async isAvailable(){let e=(0,H.normalizePath)(`${this.config.embeddingsFolder}/index.json`);return await this.app.vault.adapter.exists(e)}async loadIndex(){if(this.indexCache)return this.indexCache;try{let e=(0,H.normalizePath)(`${this.config.embeddingsFolder}/index.json`),t=await this.app.vault.adapter.read(e);return this.indexCache=JSON.parse(t),this.indexCache}catch(e){return null}}async loadEmbeddingFile(e){let t=this.embeddingsCache.get(e);if(t)return t;try{let s=(0,H.normalizePath)(`${this.config.embeddingsFolder}/embeddings/${e}.json`),n=await this.app.vault.adapter.read(s),r=JSON.parse(n);return this.embeddingsCache.set(e,r),r}catch(s){return null}}getTitleFromPath(e){return e?(e.split("/").pop()||e).replace(/\.md$/,""):"Untitled"}async getEmbedding(e){let t=await this.loadEmbeddingFile(e);return t?{noteId:t.noteId,title:t.title||this.getTitleFromPath(t.notePath),path:t.notePath,vector:t.vector}:null}async getEmbeddings(e){let t=[];for(let s of e){let n=await this.getEmbedding(s);n&&t.push(n)}return t}async getAllEmbeddings(){let e=Date.now();if(this.allEmbeddingsCache&&e-this.allEmbeddingsCacheTime<this.ALL_CACHE_TTL_MS)return this.allEmbeddingsCache;let t=await this.loadIndex();if(!t)return[];let s=[];for(let[n]of Object.entries(t.notes)){let r=await this.loadEmbeddingFile(n);r&&s.push({noteId:n,title:r.title||this.getTitleFromPath(r.notePath),path:r.notePath,vector:r.vector})}return this.allEmbeddingsCache=s,this.allEmbeddingsCacheTime=e,s}async findSimilar(e,t=20,s=this.config.defaultSimilarityThreshold){let n=await this.getEmbedding(e);return n?(await this.findSimilarByVector(n.vector,t+1,s)).filter(i=>i.noteId!==e).slice(0,t):[]}async findSimilarByVector(e,t=20,s=this.config.defaultSimilarityThreshold){let n=await this.getAllEmbeddings(),r=[];for(let i of n){let o=this.cosineSimilarity(e,i.vector);o>=s&&r.push({noteId:i.noteId,title:i.title,path:i.path,similarity:o})}return r.sort((i,o)=>o.similarity-i.similarity).slice(0,t)}cosineSimilarity(e,t){if(e.length!==t.length)return 0;let s=0,n=0,r=0;for(let i=0;i<e.length;i++)s+=e[i]*t[i],n+=e[i]*e[i],r+=t[i]*t[i];return n=Math.sqrt(n),r=Math.sqrt(r),n===0||r===0?0:s/(n*r)}async getEmbeddingByPath(e){let t=z(e);return this.getEmbedding(t)}async searchByTopic(e,t={}){let{limit:s=20,threshold:n=this.config.defaultSimilarityThreshold}=t,r=await this.getAllEmbeddings(),i=e.toLowerCase(),o=r.filter(a=>a.path.toLowerCase().includes(i)||a.title.toLowerCase().includes(i));if(o.length===0)return r.slice(0,s).map(a=>({noteId:a.noteId,title:a.title,path:a.path,similarity:.5}));let d=this.computeAverageVector(o.map(a=>a.vector));return this.findSimilarByVector(d,s,n)}computeAverageVector(e){if(e.length===0)return[];let t=e[0].length,s=new Array(t).fill(0);for(let n of e)for(let r=0;r<t;r++)s[r]+=n[r];for(let n=0;n<t;n++)s[n]/=e.length;return s}clearCache(){this.indexCache=null,this.embeddingsCache.clear(),this.allEmbeddingsCache=null,this.allEmbeddingsCacheTime=0}async getStats(){var t;let e=await this.loadIndex();return{totalNotes:e?Object.keys(e.notes).length:0,embeddingsFolder:this.config.embeddingsFolder,indexUpdated:(t=e==null?void 0:e.lastUpdated)!=null?t:null}}};var x=class{constructor(e){this.defaultTimeout=3e4;this.config=e}isConfigured(){return!!this.config.apiKey&&this.config.apiKey.trim().length>0}async generateClusterLabel(e,t){if(!this.isConfigured())return{success:!1,error:"LLM provider not configured"};let n=`Generate a short, descriptive label (2-4 words) for a cluster of notes with these titles/summaries:

${t?e.map((i,o)=>`- ${i}${t[o]?`: ${t[o]}`:""}`).join(`
`):e.map(i=>`- ${i}`).join(`
`)}

Requirements:
- The label should capture the common theme
- Keep it concise (2-4 words)
- Use title case
- Do not use punctuation

Return only the label, nothing else.`;return this.generate(n,"You are a knowledge organization assistant that creates concise, descriptive labels for groups of related notes.",{temperature:.3,maxTokens:50})}};var ye="gpt-4o-mini",Ce="https://api.openai.com/v1",L=class extends x{constructor(e){super(e),this.model=e.model||ye,this.baseUrl=e.baseUrl||Ce}buildRequestBody(e,t){var i,o;let s=Y(this.model),n=(i=t==null?void 0:t.maxTokens)!=null?i:s?4096:1e3,r={model:this.model,messages:e};return s?r.max_completion_tokens=n:(r.max_tokens=n,r.temperature=(o=t==null?void 0:t.temperature)!=null?o:.7),r}async generate(e,t,s){var n;if(!this.isConfigured())return{success:!1,error:"OpenAI API key not configured"};try{let r=[];t&&r.push({role:"system",content:t}),r.push({role:"user",content:e});let i=this.buildRequestBody(r,s),o=await fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify(i)});if(!o.ok)return{success:!1,error:`OpenAI API error: ${((n=(await o.json().catch(()=>({error:{message:o.statusText}}))).error)==null?void 0:n.message)||o.statusText}`};let d=await o.json();if(!d.choices||d.choices.length===0)return{success:!1,error:"No response from OpenAI"};let a=d.choices[0].message.content;return!a&&d.choices[0].finish_reason==="length"?{success:!1,error:"Response truncated - reasoning model may need higher token budget"}:{success:!0,content:a||"",usage:{promptTokens:d.usage.prompt_tokens,completionTokens:d.usage.completion_tokens,totalTokens:d.usage.total_tokens}}}catch(r){return{success:!1,error:`OpenAI request failed: ${r.message}`}}}async chat(e,t){var s;if(!this.isConfigured())return{success:!1,error:"OpenAI API key not configured"};try{let n=e.map(a=>({role:a.role,content:a.content})),r=this.buildRequestBody(n,t),i=await fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify(r)});if(!i.ok)return{success:!1,error:`OpenAI API error: ${((s=(await i.json().catch(()=>({error:{message:i.statusText}}))).error)==null?void 0:s.message)||i.statusText}`};let o=await i.json();if(!o.choices||o.choices.length===0)return{success:!1,error:"No response from OpenAI"};let d=o.choices[0].message.content;return!d&&o.choices[0].finish_reason==="length"?{success:!1,error:"Response truncated - reasoning model may need higher token budget"}:{success:!0,content:d||"",usage:{promptTokens:o.usage.prompt_tokens,completionTokens:o.usage.completion_tokens,totalTokens:o.usage.total_tokens}}}catch(n){return{success:!1,error:`OpenAI chat request failed: ${n.message}`}}}async validateApiKey(){if(!this.isConfigured())return!1;try{let e=Y(this.model),t={model:this.model,messages:[{role:"user",content:"Hello"}]};return e?t.max_completion_tokens=10:t.max_tokens=10,(await fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify(t)})).ok}catch(e){return!1}}getName(){return"OpenAI"}getAvailableModels(){return["gpt-5.2","o3-mini","gpt-4o","gpt-4o-mini"]}};var xe="claude-sonnet-4-20250514",Ne="https://api.anthropic.com/v1",Z="2023-06-01",I=class extends x{constructor(e){super(e),this.model=e.model||xe,this.baseUrl=e.baseUrl||Ne}async generate(e,t,s){var n,r;if(!this.isConfigured())return{success:!1,error:"Anthropic API key not configured"};try{let i=[{role:"user",content:e}],o=await fetch(`${this.baseUrl}/messages`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.config.apiKey,"anthropic-version":Z},body:JSON.stringify({model:this.model,max_tokens:(n=s==null?void 0:s.maxTokens)!=null?n:1e3,system:t,messages:i})});if(!o.ok)return{success:!1,error:`Anthropic API error: ${((r=(await o.json().catch(()=>({error:{message:o.statusText}}))).error)==null?void 0:r.message)||o.statusText}`};let d=await o.json();if(!d.content||d.content.length===0)return{success:!1,error:"No response from Anthropic"};let a=d.content.find(l=>l.type==="text");return a?{success:!0,content:a.text,usage:{promptTokens:d.usage.input_tokens,completionTokens:d.usage.output_tokens,totalTokens:d.usage.input_tokens+d.usage.output_tokens}}:{success:!1,error:"No text content in response"}}catch(i){return{success:!1,error:`Anthropic request failed: ${i.message}`}}}async chat(e,t){var s,n;if(!this.isConfigured())return{success:!1,error:"Anthropic API key not configured"};try{let r=e.find(l=>l.role==="system"),i=e.filter(l=>l.role!=="system").map(l=>({role:l.role,content:l.content})),o=await fetch(`${this.baseUrl}/messages`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.config.apiKey,"anthropic-version":Z},body:JSON.stringify({model:this.model,max_tokens:(s=t==null?void 0:t.maxTokens)!=null?s:1e3,system:r==null?void 0:r.content,messages:i})});if(!o.ok)return{success:!1,error:`Anthropic API error: ${((n=(await o.json().catch(()=>({error:{message:o.statusText}}))).error)==null?void 0:n.message)||o.statusText}`};let d=await o.json();if(!d.content||d.content.length===0)return{success:!1,error:"No response from Anthropic"};let a=d.content.find(l=>l.type==="text");return a?{success:!0,content:a.text,usage:{promptTokens:d.usage.input_tokens,completionTokens:d.usage.output_tokens,totalTokens:d.usage.input_tokens+d.usage.output_tokens}}:{success:!1,error:"No text content in response"}}catch(r){return{success:!1,error:`Anthropic chat request failed: ${r.message}`}}}async validateApiKey(){if(!this.isConfigured())return!1;try{return(await fetch(`${this.baseUrl}/messages`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.config.apiKey,"anthropic-version":Z},body:JSON.stringify({model:this.model,max_tokens:1,messages:[{role:"user",content:"Hi"}]})})).ok}catch(e){return!1}}getName(){return"Anthropic"}getAvailableModels(){return["claude-sonnet-4-20250514","claude-3-5-sonnet-20241022","claude-3-5-haiku-20241022","claude-3-opus-20240229"]}};var we="gemini-3-flash-preview",Pe="https://generativelanguage.googleapis.com/v1beta",O=class extends x{constructor(e){super(e),this.model=e.model||we,this.baseUrl=e.baseUrl||Pe}async generate(e,t,s){var n,r,i,o,d,a,l;if(!this.isConfigured())return{success:!1,error:"Gemini API key not configured"};try{let p={contents:[{role:"user",parts:[{text:e}]}],generationConfig:{temperature:(n=s==null?void 0:s.temperature)!=null?n:.7,maxOutputTokens:(r=s==null?void 0:s.maxTokens)!=null?r:1e3}};t&&(p.systemInstruction={parts:[{text:t}]});let u=await fetch(`${this.baseUrl}/models/${this.model}:generateContent?key=${this.config.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)});if(!u.ok)return{success:!1,error:`Gemini API error: ${((i=(await u.json().catch(()=>({error:{message:u.statusText}}))).error)==null?void 0:i.message)||u.statusText}`};let m=await u.json();if(!m.candidates||m.candidates.length===0)return{success:!1,error:"No response from Gemini"};let v=(l=(a=(d=(o=m.candidates[0])==null?void 0:o.content)==null?void 0:d.parts)==null?void 0:a[0])==null?void 0:l.text;return v?{success:!0,content:v,usage:m.usageMetadata?{promptTokens:m.usageMetadata.promptTokenCount,completionTokens:m.usageMetadata.candidatesTokenCount,totalTokens:m.usageMetadata.totalTokenCount}:void 0}:{success:!1,error:"No text content in response"}}catch(g){return{success:!1,error:`Gemini request failed: ${g.message}`}}}async chat(e,t){var s,n,r,i,o,d,a;if(!this.isConfigured())return{success:!1,error:"Gemini API key not configured"};try{let l=e.find(h=>h.role==="system"),p={contents:e.filter(h=>h.role!=="system").map(h=>({role:h.role==="assistant"?"model":"user",parts:[{text:h.content}]})),generationConfig:{temperature:(s=t==null?void 0:t.temperature)!=null?s:.7,maxOutputTokens:(n=t==null?void 0:t.maxTokens)!=null?n:1e3}};l&&(p.systemInstruction={parts:[{text:l.content}]});let u=await fetch(`${this.baseUrl}/models/${this.model}:generateContent?key=${this.config.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)});if(!u.ok)return{success:!1,error:`Gemini API error: ${((r=(await u.json().catch(()=>({error:{message:u.statusText}}))).error)==null?void 0:r.message)||u.statusText}`};let m=await u.json();if(!m.candidates||m.candidates.length===0)return{success:!1,error:"No response from Gemini"};let v=(a=(d=(o=(i=m.candidates[0])==null?void 0:i.content)==null?void 0:o.parts)==null?void 0:d[0])==null?void 0:a.text;return v?{success:!0,content:v,usage:m.usageMetadata?{promptTokens:m.usageMetadata.promptTokenCount,completionTokens:m.usageMetadata.candidatesTokenCount,totalTokens:m.usageMetadata.totalTokenCount}:void 0}:{success:!1,error:"No text content in response"}}catch(l){return{success:!1,error:`Gemini chat request failed: ${l.message}`}}}async validateApiKey(){if(!this.isConfigured())return!1;try{return(await fetch(`${this.baseUrl}/models?key=${this.config.apiKey}`,{method:"GET"})).ok}catch(e){return!1}}getName(){return"Gemini"}getAvailableModels(){return["gemini-3-pro-preview","gemini-3-flash-preview","gemini-2.0-flash"]}};var Me="grok-4-1-fast-non-reasoning",Ee="https://api.x.ai/v1",D=class extends x{constructor(e){super(e),this.model=e.model||Me,this.baseUrl=e.baseUrl||Ee}async generate(e,t,s){var n,r,i;if(!this.isConfigured())return{success:!1,error:"Grok API key not configured"};try{let o=[];t&&o.push({role:"system",content:t}),o.push({role:"user",content:e});let d=await fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify({model:this.model,messages:o,temperature:(n=s==null?void 0:s.temperature)!=null?n:.7,max_tokens:(r=s==null?void 0:s.maxTokens)!=null?r:1e3})});if(!d.ok)return{success:!1,error:`Grok API error: ${((i=(await d.json().catch(()=>({error:{message:d.statusText}}))).error)==null?void 0:i.message)||d.statusText}`};let a=await d.json();return!a.choices||a.choices.length===0?{success:!1,error:"No response from Grok"}:{success:!0,content:a.choices[0].message.content,usage:{promptTokens:a.usage.prompt_tokens,completionTokens:a.usage.completion_tokens,totalTokens:a.usage.total_tokens}}}catch(o){return{success:!1,error:`Grok request failed: ${o.message}`}}}async chat(e,t){var s,n,r;if(!this.isConfigured())return{success:!1,error:"Grok API key not configured"};try{let i=e.map(a=>({role:a.role,content:a.content})),o=await fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify({model:this.model,messages:i,temperature:(s=t==null?void 0:t.temperature)!=null?s:.7,max_tokens:(n=t==null?void 0:t.maxTokens)!=null?n:1e3})});if(!o.ok)return{success:!1,error:`Grok API error: ${((r=(await o.json().catch(()=>({error:{message:o.statusText}}))).error)==null?void 0:r.message)||o.statusText}`};let d=await o.json();return!d.choices||d.choices.length===0?{success:!1,error:"No response from Grok"}:{success:!0,content:d.choices[0].message.content,usage:{promptTokens:d.usage.prompt_tokens,completionTokens:d.usage.completion_tokens,totalTokens:d.usage.total_tokens}}}catch(i){return{success:!1,error:`Grok chat request failed: ${i.message}`}}}async validateApiKey(){if(!this.isConfigured())return!1;try{return(await fetch(`${this.baseUrl}/models`,{method:"GET",headers:{Authorization:`Bearer ${this.config.apiKey}`}})).ok}catch(e){return!1}}getName(){return"Grok"}getAvailableModels(){return["grok-4-1-fast","grok-4-1-fast-non-reasoning"]}};var W=class extends N.Plugin{constructor(){super(...arguments);this.llmProvider=null}async onload(){await this.loadSettings(),this.canvasRepository=new q(this.app),this.embeddingsAdapter=new k(this.app,{embeddingsFolder:this.settings.embeddings.folder}),this.initializeLLMProvider(),this.addCommand({id:"generate-canvas-from-topic",name:"Generate Canvas from Topic",callback:()=>this.openCanvasModal()}),this.addCommand({id:"generate-canvas-from-note",name:"Generate Canvas from Current Note",checkCallback:t=>{let s=this.app.workspace.getActiveFile();return s&&s.extension==="md"?(t||this.openCanvasModal(void 0,s.path),!0):!1}}),this.addSettingTab(new R(this.app,this)),this.addRibbonIcon("network","Generate Knowledge Canvas",()=>{this.openCanvasModal()})}async onunload(){}async loadSettings(){this.settings=Object.assign({},se,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.initializeLLMProvider(),this.embeddingsAdapter=new k(this.app,{embeddingsFolder:this.settings.embeddings.folder})}initializeLLMProvider(){let{provider:t,apiKeys:s,model:n}=this.settings.ai,r=s[t];if(!r){this.llmProvider=null;return}switch(t){case"openai":this.llmProvider=new L({apiKey:r,model:n});break;case"claude":this.llmProvider=new I({apiKey:r,model:n});break;case"gemini":this.llmProvider=new O({apiKey:r,model:n});break;case"grok":this.llmProvider=new D({apiKey:r,model:n});break;default:this.llmProvider=null}}async testApiKey(t,s){let n;switch(t){case"openai":n=new L({apiKey:s});break;case"claude":n=new I({apiKey:s});break;case"gemini":n=new O({apiKey:s});break;case"grok":n=new D({apiKey:s});break;default:return!1}return n.validateApiKey()}openCanvasModal(t,s){new G(this.app,this.settings,r=>this.generateCanvas(r),t,s).open()}async generateCanvas(t){var r,i;if(!await this.embeddingsAdapter.isAvailable()){new N.Notice("Vault Embeddings not found. Please install and configure the plugin.");return}let n=new F(this.app);n.open(),n.initSteps(["Finding related notes","Computing spatial layout","Clustering notes","Generating cluster labels","Creating canvas file"]);try{n.setCurrentStep(0),n.setStatus("Searching for related notes...");let o;if(t.seedNotePath){let m=z(t.seedNotePath),h=(await this.embeddingsAdapter.findSimilar(m,t.maxNodes,t.minSimilarity)).map(w=>w.noteId);h.unshift(m),o=await this.embeddingsAdapter.getEmbeddings(h)}else if(t.topic){let v=(await this.embeddingsAdapter.searchByTopic(t.topic,{limit:t.maxNodes,threshold:t.minSimilarity})).map(h=>h.noteId);o=await this.embeddingsAdapter.getEmbeddings(v)}if(!o||o.length===0){n.setError(0,"No related notes found");return}n.updateStep(0,"completed",`Found ${o.length} notes`),n.setCurrentStep(1),n.setStatus("Computing spatial layout...");let d=new K({nodeWidth:this.settings.canvas.nodeWidth,nodeHeight:this.settings.canvas.nodeHeight,clusterEps:this.settings.clustering.eps,clusterMinPts:this.settings.clustering.minPts,edgeThreshold:t.minSimilarity}),a=o,l=d.buildCanvas(a,{includeClusterLabels:t.includeClusterLabels,showEdges:t.showEdges,edgeThreshold:t.minSimilarity});n.updateStep(1,"completed"),n.setCurrentStep(2),n.setStatus("Clustering notes...");let g=l.getGroupNodes();if(n.updateStep(2,"completed",`${g.length} clusters`),n.setCurrentStep(3),t.includeClusterLabels&&this.llmProvider&&g.length>0){n.setStatus("Generating cluster labels...");let m=new Map;for(let w of o)m.set(w.path,w.title);let h=await new V({llmProvider:this.llmProvider}).execute({graph:l,pathToTitle:m});h.success?n.updateStep(3,"completed",`${h.labelsGenerated} labels`):n.updateStep(3,"completed","Skipped (no LLM)")}else n.updateStep(3,"completed","Skipped");n.setCurrentStep(4),n.setStatus("Creating canvas file...");let p=t.topic||((i=(r=t.seedNotePath)==null?void 0:r.split("/").pop())==null?void 0:i.replace(".md",""))||"knowledge-map",u=this.canvasRepository.generateCanvasPath(p,t.outputFolder);if(t.outputFolder){let m=(0,N.normalizePath)(t.outputFolder);if(!await this.app.vault.adapter.exists(m))try{await this.app.vault.createFolder(m)}catch(h){if(!(h instanceof Error&&h.message.includes("already exists")))throw h}}await this.canvasRepository.save(u,l),n.updateStep(4,"completed"),n.complete("Canvas generated successfully!"),setTimeout(async()=>{n.close(),await this.canvasRepository.open(u),new N.Notice(`Canvas created: ${u}`)},1e3)}catch(o){let d=o instanceof Error?o.message:"Unknown error";new N.Notice(`Failed to generate canvas: ${d}`),n.setError(0,d)}}};
